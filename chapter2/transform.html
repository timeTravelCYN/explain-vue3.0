<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      transform 优化 AST | Vue3.0 源码解读
    </title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/explain-vue3.0/assets/style.db5c977a.css">
    <link rel="modulepreload" href="/explain-vue3.0/assets/framework.5c8a4622.js">
    <link rel="modulepreload" href="/explain-vue3.0/assets/Home.4846fabc.js">
    <link rel="modulepreload" href="/explain-vue3.0/assets/chapter2_transform.md.9f1e7092.lean.js">
    <link rel="modulepreload" href="/explain-vue3.0/assets/app.d80da221.js">
    <style>img { border-radius: 10px }h1.title { margin-left: 0.5em }</style>
    
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-6e7c0b86><div class="sidebar-button" data-v-6e7c0b86><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/explain-vue3.0/" aria-label="Vue3.0 源码解读, back to home" data-v-6e7c0b86 data-v-00c3af85><!----> Vue3.0 源码解读</a><div class="flex-grow" data-v-6e7c0b86></div><div class="nav" data-v-6e7c0b86><nav class="nav-links" data-v-6e7c0b86 data-v-f465d38e><!--[--><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-98431d6e><a class="item isExternal" href="https://github.com/WJCHumble/explain-vue3.0" target="_blank" rel="noopener noreferrer" data-v-98431d6e>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-98431d6e><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-58e261f2><nav class="nav-links nav" data-v-58e261f2 data-v-f465d38e><!--[--><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-98431d6e><a class="item isExternal" href="https://github.com/WJCHumble/explain-vue3.0" target="_blank" rel="noopener noreferrer" data-v-98431d6e>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-98431d6e><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-58e261f2><!--[--><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><p class="sidebar-link-item" data-v-58e261f2>项目结构设计</p><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter1/" data-v-58e261f2>基本介绍</a><!----></li></ul></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><p class="sidebar-link-item" data-v-58e261f2>模板编译</p><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter2/" data-v-58e261f2>基本介绍</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter2/baseParse" data-v-58e261f2>baseParse 解析生成 AST</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter2/generate" data-v-58e261f2>generate 生成可执行代码</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter2/transform" data-v-58e261f2>transform 优化 AST</a><!----></li></ul></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><p class="sidebar-link-item" data-v-58e261f2>组件创建过程</p><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter3/" data-v-58e261f2>基本介绍</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter3/setupComponent" data-v-58e261f2>setupComponent</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter3/finishComponentSetup" data-v-58e261f2>finishComponentSetup</a><!----></li></ul></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><p class="sidebar-link-item" data-v-58e261f2>组件更新过程</p><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter4/" data-v-58e261f2>基本介绍</a><!----></li></ul></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><p class="sidebar-link-item" data-v-58e261f2>基于 Proxy 的响应式原理</p><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter5/" data-v-58e261f2>基本介绍</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter5/reactive" data-v-58e261f2>reactive API</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter5/depCollection" data-v-58e261f2>依赖收集（track）</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter5/notifyUpdate" data-v-58e261f2>派发更新（trigger）</a><!----></li></ul></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><p class="sidebar-link-item" data-v-58e261f2>内置组件</p><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter6/" data-v-58e261f2>基本介绍</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter6/teleport" data-v-58e261f2>teleport</a><!----></li></ul></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><p class="sidebar-link-item" data-v-58e261f2>常用指令</p><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter7/" data-v-58e261f2>基本介绍</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter7/v-if" data-v-58e261f2>v-if</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="/explain-vue3.0/chapter7/v-show" data-v-58e261f2>v-show</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-b109f666><div class="container" data-v-b109f666><!--[--><!--]--><div class="content" data-v-b109f666><div data-v-b109f666><h1 id="transform-优化-ast"><a class="header-anchor" href="#transform-优化-ast" aria-hidden="true">#</a> transform 优化 AST</h1><p>熟悉 Vue 2.x 版本源码的同学应该都知道它的 <code>compile</code> 阶段是没有 <code>transform</code> 过程的处理。而 <code>transform</code> 恰恰是整个 Vue 3 提高 <code>VNode</code> 更新性能实现的基础。因为，在这个阶段，会对 <code>baseCompiler</code> 后生成的 AST Element 打上优化标识 <code>patchFlag</code>，以及 <code>isBlock</code> 的判断。</p><blockquote><p>实际上 Vue 3 的 <code>transfrom</code> 并不是无米之炊，它本质上是 Vue 2.x <code>compiler</code> 阶段的 <code>optimize</code> 的升级版。</p></blockquote><p>这里我们将对 AST Elment 的 <code>transform</code> 分为两类：</p><ul><li>静态节点 <code>transform</code> 应用，即节点不含有插值、指令、props、动态样式的绑定等。</li><li>动态节点 <code>transform</code> 应用，即节点含有插值、指令、props、动态样式的绑定等。</li></ul><h2 id="静态节点-transform-应用"><a class="header-anchor" href="#静态节点-transform-应用" aria-hidden="true">#</a> 静态节点 transform 应用</h2><p>那么，首先是静态节点 <code>transform</code> 应用。对于上面我们说到的这个栗子，静态节点就是 <code>&lt;div&gt;hi vue3&lt;/div&gt;</code>这部分。而它在没有进行 <code>transformText</code> 之前，它对应的 AST 会是这样：</p><div class="language-javascript"><pre><code><span class="token punctuation">{</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    content<span class="token operator">:</span> <span class="token string">&quot;hi vue3&quot;</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>start<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> source<span class="token operator">:</span> <span class="token string">&quot;hi vue3&quot;</span><span class="token punctuation">}</span>
    type<span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
  codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span>
  isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>start<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> source<span class="token operator">:</span> <span class="token string">&quot;&lt;div&gt;hi vue3&lt;/div&gt;&quot;</span><span class="token punctuation">}</span>
  ns<span class="token operator">:</span> <span class="token number">0</span>
  props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  tag<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span>
  tagType<span class="token operator">:</span> <span class="token number">0</span>
  type<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，此时它的 <code>codegenNode</code> 是 <code>undefined</code>。而在 <code>transform</code> 阶段则会根据 AST 递归应用对应的 <code>plugin</code>，然后，创建对应 AST Element 的 <code>codegen</code> 对象。所以，此时我们会命中 <code>transformElement</code> 和 <code>transformText</code> 的逻辑。</p><p><strong>transformText</strong></p><p><code>transformText</code> 顾名思义，它和<strong>文本</strong>相关。很显然，我们此时 AST Element 所属的类型就是 Text。那么，我们先来看一下 <code>transformText</code> 函数对应的伪代码：</p><div class="language-javascript"><pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> transformText<span class="token operator">:</span> <span class="token function-variable function">NodeTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ROOT</span> <span class="token operator">||</span>
    node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">||</span>
    node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">FOR</span> <span class="token operator">||</span>
    node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF_BRANCH</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> node<span class="token punctuation">.</span>children
      <span class="token keyword">let</span> currentContainer<span class="token operator">:</span> CompoundExpressionNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
      <span class="token keyword">let</span> hasText <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// {1}</span>
        <span class="token keyword">const</span> child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isText</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          hasText <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token operator">...</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span>hasText <span class="token operator">||</span>
        <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ROOT</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">&amp;&amp;</span>
              node<span class="token punctuation">.</span>tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// {2}</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，这里我们会命中 {2} 逻辑，即如果对于节点含有单一文本 <code>transformText</code> 并不需要进行额外的处理。该节点仍然和 Vue 2.x 版本一样，会交给 <code>runtime</code> 时的 <code>render</code> 函数处理。</p><blockquote><p>至于 <code>transfromText</code> 真正发挥作用的场景是当存在 <code>&lt;div&gt;ab {a} {b}&lt;/div&gt;</code> 情况时，它需要将两者放在一个单独的 AST Element（Compound Expression） 下。</p></blockquote><p><strong>transformElement</strong></p><p><code>transformElement</code> 是一个所有 AST Element 都会被执行的一个 <code>plugin</code>，它的核心是为 AST Element 生成最基础的 <code>codegen</code>属性。例如标识出对应 <code>patchFlag</code>，从而为生成 <code>VNode</code> 提供依据，即 <code>dynamicChildren</code>。</p><p>而对于静态节点，同样只是起到一个初始化它的 <code>codegenNode</code> 属性的作用。并且，从上面介绍的 <code>patchFlag</code> 的类型，我们可以知道它的 <code>patchFlag</code> 为默认值 <code>0</code>。所以，它的 <code>codegenNode</code> 属性值看起来会是这样：</p><div class="language-javascript"><pre><code><span class="token punctuation">{</span>
  children<span class="token operator">:</span> <span class="token punctuation">{</span>
    content<span class="token operator">:</span> <span class="token string">&quot;hi vue3&quot;</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>start<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> source<span class="token operator">:</span> <span class="token string">&quot;hi vue3&quot;</span><span class="token punctuation">}</span>
    type<span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>
  directives<span class="token operator">:</span> <span class="token keyword">undefined</span>
  disableTracking<span class="token operator">:</span> <span class="token boolean">false</span>
  dynamicProps<span class="token operator">:</span> <span class="token keyword">undefined</span>
  isBlock<span class="token operator">:</span> <span class="token boolean">false</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>start<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> source<span class="token operator">:</span> <span class="token string">&quot;&lt;div&gt;hi vue3&lt;/div&gt;&quot;</span><span class="token punctuation">}</span>
  patchFlag<span class="token operator">:</span> <span class="token keyword">undefined</span>
  props<span class="token operator">:</span> <span class="token keyword">undefined</span>
  tag<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>div<span class="token string">&quot;&quot;</span>
  type<span class="token operator">:</span> <span class="token number">13</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="动态节点-transform-应用"><a class="header-anchor" href="#动态节点-transform-应用" aria-hidden="true">#</a> 动态节点 transform 应用</h2><p>接下来是动态节点 <code>transform</code> 应用。这里，我们的动态节点是 <code>&lt;div&gt;&lt;/div&gt;</code>。它在 <code>baseParse</code> 后对应的 AST 会是这样：</p><div class="language-javascript"><pre><code><span class="token punctuation">{</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      content<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">}</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>start<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> source<span class="token operator">:</span> <span class="token string">&quot;{{msg}}&quot;</span><span class="token punctuation">}</span>
      type<span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>start<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> source<span class="token operator">:</span> <span class="token string">&quot;&lt;div&gt;{{msg}}&lt;/div&gt;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  ns<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  tag<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  tagType<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>很显然 <code></code> 也是文本，所以也会命中和 <code>hi vue3</code> 一样的 <code>transformText</code> 函数的逻辑。</p><blockquote><p>这里就不对 <code>transformText</code> 做展开，因为表现和 <code>hi vue3</code> 一样。</p></blockquote><p><strong>transformElements</strong></p><p>此时，对于插值文本，<code>transfromElements</code> 的价值就会体现出来了。而针对存在单一节点的插值文本，它会两件事：</p><ul><li>标识 <code>patchFlag</code> 为 <code>1 /* TEXT */</code>，即动态的文本内容。</li><li>将插值文本对应的 AST Element 赋值给 <code>VNodeChildren</code>。</li></ul><p>具体在源码中的表现会是这样（伪代码）：</p><div class="language-javascript"><pre><code>    <span class="token operator">...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> vnodeTag <span class="token operator">!==</span> <span class="token constant">TELEPORT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">const</span> type <span class="token operator">=</span> child<span class="token punctuation">.</span>type
        <span class="token comment">// check for dynamic text children</span>
        <span class="token keyword">const</span> hasDynamicTextChild <span class="token operator">=</span>
          type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span> <span class="token operator">||</span>
          type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMPOUND_EXPRESSION</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDynamicTextChild <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getStaticType</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">TEXT</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDynamicTextChild <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">/* TEXT */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            vnodeChildren <span class="token operator">=</span> child<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token comment">// bitwise flags</span>
        <span class="token keyword">const</span> flagNames <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>PatchFlagNames<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Number<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> patchFlag <span class="token operator">&amp;</span> n<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> PatchFlagNames<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">, </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        vnodePatchFlag <span class="token operator">=</span> patchFlag <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> /* </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>flagNames<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> */</span><span class="token template-punctuation string">`</span></span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    node<span class="token punctuation">.</span>codegenNode <span class="token operator">=</span> <span class="token function">createVNodeCall</span><span class="token punctuation">(</span>
      context<span class="token punctuation">,</span>
      vnodeTag<span class="token punctuation">,</span>
      vnodeProps<span class="token punctuation">,</span>
      vnodeChildren<span class="token punctuation">,</span>
      vnodePatchFlag<span class="token punctuation">,</span>
      vnodeDynamicProps<span class="token punctuation">,</span>
      vnodeDirectives<span class="token punctuation">,</span>
      <span class="token operator">!</span><span class="token operator">!</span>shouldUseBlock<span class="token punctuation">,</span>
      <span class="token boolean">false</span> <span class="token comment">/* disableTracking */</span><span class="token punctuation">,</span>
      node<span class="token punctuation">.</span>loc
    <span class="token punctuation">)</span>
</code></pre></div><p>可以看到，处理后的 <code>vnodePatchFlag</code> 和 <code>vnodeChildren</code> 是作为参数传入 <code>createVNodeCall</code>，而 <code>createVNode</code> 最终会将这些参数转化为 AST Element 上属性的值，例如 <code>children</code>、<code>patchFlag</code>。所以，<code>transformElement</code> 处理后，其生成对应的 <code>codegenNode</code> 属性值会是这样：</p><div class="language-javascript"><pre><code><span class="token punctuation">{</span>
  children<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  directives<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  dynamicProps<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  isBlock<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  isForBlock<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span>
    source<span class="token operator">:</span> <span class="token string">&quot;&lt;div&gt;{{msg}}&lt;/div&gt;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  patchFlag<span class="token operator">:</span> <span class="token string">&quot;1 /* TEXT */&quot;</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  tag<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>div<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token number">13</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div><footer class="page-footer" data-v-b109f666 data-v-5a019cc9><div class="edit" data-v-5a019cc9><div class="edit-link" data-v-5a019cc9 data-v-fb0131f2><!----></div></div><div class="updated" data-v-5a019cc9><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"8f885eb6\",\"chapter1_index.md\":\"299676e8\",\"chapter2_baseparse.md\":\"46d23079\",\"chapter2_generate.md\":\"d10fa531\",\"chapter2_index.md\":\"a52b7e60\",\"chapter2_transform.md\":\"9f1e7092\",\"chapter4_index.md\":\"75aaccc9\",\"chapter5_depcollection.md\":\"43518db0\",\"chapter5_index.md\":\"0ab5d752\",\"chapter5_notifyupdate.md\":\"27127822\",\"chapter5_reactive.md\":\"b9b92c7f\",\"chapter3_finishcomponentsetup.md\":\"cae72f6a\",\"chapter3_index.md\":\"3a28e5f6\",\"chapter3_setupcomponent.md\":\"71cf12fb\",\"chapter6_index.md\":\"675bfe2e\",\"chapter6_teleport.md\":\"74e4d0db\",\"chapter7_index.md\":\"07ee2153\",\"chapter7_v-if.md\":\"caafbe7d\",\"chapter7_v-show.md\":\"11e67776\"}")</script>
    <script type="module" async src="/explain-vue3.0/assets/app.d80da221.js"></script>
  </body>
</html>